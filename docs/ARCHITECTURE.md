# 智策云系统架构设计

## 整体架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        客户端层 (Client Layer)                    │
│                      (Browser / Mobile App)                      │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                        前端层 (Frontend Layer)                    │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                   Next.js + React App                      │   │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────────┐ │   │
│  │  │ Dashboard│  │  Report │  │ Company │  │ ServiceOrder│ │   │
│  │  │  Page    │  │  Page   │  │  Page   │  │    Page     │ │   │
│  │  └─────────┘  └─────────┘  └─────────┘  └─────────────┘ │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                        API网关层 (API Gateway)                    │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌───────────────┐  │ │
│  │  │ Auth    │  │Company  │  │ Report  │  │ NFS Agent     │  │ │
│  │  │ API     │  │ API     │  │ API     │  │ API           │  │ │
│  │  └─────────┘  └─────────┘  └─────────┘  └───────────────┘  │ │
│  └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                       后端服务层 (Backend Layer)                  │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                    Express.js Server                         │ │
│  │  ┌────────────┐  ┌────────────┐  ┌──────────────────────┐   │ │
│  │  │ Controllers│  │ Services   │  │  NFS-Agent Engine    │   │ │
│  │  └────────────┘  └────────────┘  └──────────────────────┘   │ │
│  │  ┌────────────┐  ┌────────────┐  ┌──────────────────────┐   │ │
│  │  │ Middleware │  │ Utilities  │  │  Data Processors     │   │ │
│  │  └────────────┘  └────────────┘  └──────────────────────┘   │ │
│  └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                        数据层 (Data Layer)                       │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │
│  │ PostgreSQL  │  │   Redis     │  │   External APIs         │  │
│  │  Database   │  │   Cache     │  │ (Jumin, Enterprise Data)│  │
│  └─────────────┘  └─────────────┘  └─────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

## 核心模块设计

### 1. NFS-Agent (净融资空间计算智能体)

```
┌──────────────────────────────────────────────────────────────┐
│                     NFS-Agent Pipeline                         │
├──────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌───────────┐    ┌───────────┐    ┌───────────────┐        │
│  │ Input     │───▶│ Data      │───▶│ Risk          │        │
│  │ Processor │    │ Analyzer  │    │ Calculator    │        │
│  └───────────┘    └───────────┘    └───────────────┘        │
│       │                                  │                   │
│       ▼                                  ▼                   │
│  ┌──────────────────────────────────────────────┐            │
│  │           Financing Space Calculator          │            │
│  │  ┌─────────────────────────────────────────┐  │            │
│  │  │  NetFinancingSpace = Assets - Liabilities│  │            │
│  │  │  - RiskReserve - OperatingReserve       │  │            │
│  │  └─────────────────────────────────────────┘  │            │
│  └──────────────────────────────────────────────┘            │
│                            │                                  │
│                            ▼                                  │
│  ┌──────────────────────────────────────────────────┐         │
│  │           Asset Recommender (R ≥ 25%)            │         │
│  │  ┌─────────────┐  ┌─────────────┐              │         │
│  │  │ Return Rate │  │ Risk Level  │──▶ Filtered  │         │
│  │  │ Calculator  │  │ Assigner    │    Assets    │         │
│  │  └─────────────┘  └─────────────┘              │         │
│  └──────────────────────────────────────────────────┘         │
│                            │                                  │
│                            ▼                                  │
│  ┌──────────────────────────────────────────────────┐         │
│  │              Report Generator                     │         │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────────────┐   │         │
│  │  │ Summary │  │  Charts  │  │ Recommendations│   │         │
│  │  └─────────┘  └─────────┘  └─────────────────┘   │         │
│  └──────────────────────────────────────────────────┘         │
│                                                               │
└──────────────────────────────────────────────────────────────┘
```

### 2. 数据流设计

```
┌──────────────────────────────────────────────────────────────────┐
│                         数据流程图                                 │
├──────────────────────────────────────────────────────────────────┤
│                                                                  │
│   ┌─────────────┐                                               │
│   │  三件套输入  │                                               │
│   │(Jumin+征信) │                                               │
│   └──────┬──────┘                                               │
│          │                                                       │
│          ▼                                                       │
│   ┌─────────────┐    ┌─────────────────┐                        │
│   │  数据解析器  │───▶│ 企业信息提取    │                        │
│   └─────────────┘    │ (自动填充表单)   │                        │
│                      └────────┬────────┘                        │
│                               │                                   │
│                               ▼                                   │
│   ┌──────────────────────────────────────────┐                  │
│   │           大数据风控分析                   │                  │
│   │  ┌──────────┐  ┌──────────┐  ┌─────────┐  │                  │
│   │  │ 工商数据 │  │ 司法数据 │  │ 税务数据│  │                  │
│   │  └────┬─────┘  └────┬─────┘  └────┬────┘  │                  │
│   │       │            │            │       │                  │
│   │       └────────────┼────────────┘       │                  │
│   │                    ▼                    │                  │
│   │            ┌──────────────┐             │                  │
│   │            │  综合风险评分 │             │                  │
│   │            └──────┬───────┘             │                  │
│   └───────────────────┼──────────────────────┘                  │
│                       │                                          │
│                       ▼                                          │
│   ┌──────────────────────────────────────────────────┐           │
│   │              NFS-Agent 计算                      │           │
│   │  ┌─────────────────────────────────────────────┐ │           │
│   │  │ NetFinancingSpace = AvailableCapital ×    │ │           │
│   │  │                   (1 - RiskFactor) × R     │ │           │
│   │  └─────────────────────────────────────────────┘ │           │
│   └──────────────────────────────────────────────────┘           │
│                       │                                          │
│                       ▼                                          │
│   ┌──────────────────────────────────────────────────┐           │
│   │              资产配置推荐 (R ≥ 25%)               │           │
│   └──────────────────────────────────────────────────┘           │
│                       │                                          │
│                       ▼                                          │
│   ┌──────────────────────────────────────────────────┐           │
│   │              报告生成 & 工单创建                   │           │
│   └──────────────────────────────────────────────────┘           │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘
```

### 3. 数据库设计 (Prisma Schema)

#### 核心实体关系

```
User (用户)
  │
  ├── Company (企业)
  │       │
  │       ├── FinancialData (财务数据)
  │       │
  │       └── Report (报告)
  │               │
  │               └── AssetRecommendation (资产推荐)
  │
  └── ServiceOrder (服务工单)
```

## API设计

### 基础路径
- 开发环境: `http://localhost:3001/api`
- 生产环境: `https://api.zhiceyun.com/api`

### 核心API

| 模块 | 端点 | 方法 | 描述 |
|------|------|------|------|
| Auth | `/auth/register` | POST | 用户注册 |
| Auth | `/auth/login` | POST | 用户登录 |
| Company | `/companies` | GET | 获取企业列表 |
| Company | `/companies` | POST | 创建企业 |
| Company | `/companies/:id` | GET | 获取企业详情 |
| Report | `/reports` | GET | 获取报告列表 |
| Report | `/reports/generate` | POST | 生成报告 |
| NFS | `/nfs/calculate` | POST | 计算净融资空间 |
| ServiceOrder | `/service-orders` | POST | 创建服务工单 |

## 部署架构

```
┌─────────────────────────────────────────────────────────────┐
│                      Docker Compose                         │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐  ┌─────────────────┐                  │
│  │   Frontend      │  │    Backend      │                  │
│  │   (Next.js)     │  │   (Express)     │                  │
│  └────────┬────────┘  └────────┬────────┘                  │
│           │                    │                            │
│  ┌────────┴────────────────────┴────────┐                  │
│  │         Traefik / Nginx              │                  │
│  └─────────────────┬────────────────────┘                  │
│                    │                                         │
│  ┌─────────────────┴────────────────────┐                  │
│  │           PostgreSQL + Redis          │                  │
│  └───────────────────────────────────────┘                  │
└─────────────────────────────────────────────────────────────┘
```
